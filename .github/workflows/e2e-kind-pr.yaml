name: E2E K8s 1.35.0 (Kind PR)

on:
  pull_request:
    branches: [main]
    paths:
      - 'kagenti/**'
      - 'deployments/**'
      - '.github/**'
      - 'charts/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'kagenti/ui-v2/package.json'
      - 'kagenti/ui-v2/package-lock.json'

# Explicit permissions - principle of least privilege
permissions:
  contents: read

# Version tracking - keep in sync with deployments/ansible/kind/kind-config.yaml
env:
  K8S_VERSION: '1.35.0'  # Must match kindest/node version in kind-config.yaml

jobs:
  e2e-dev-kagenti-operator:
    name: Deploy & Test
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.11'

      - name: Install kubectl
        uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede  # v4

      - name: Install Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4  # v4
        with:
          version: 'v3.17.0'  # Pin to v3 - Helm v4 has breaking changes incompatible with ansible kubernetes.core.helm module

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3

      - name: Free up disk space
        run: bash .github/scripts/common/05-free-disk-space.sh

      - name: Setup Python and Ansible dependencies
        run: bash .github/scripts/common/10-setup-dependencies.sh

      - name: Create secret values file for CI
        run: bash .github/scripts/common/20-create-secrets.sh

      - name: Run Ansible installer (dev mode with kagenti-operator)
        run: bash .github/scripts/kagenti-operator/30-run-installer.sh

      - name: Wait for platform to be ready
        run: bash .github/scripts/common/40-wait-platform-ready.sh

      - name: Install Ollama
        run: bash .github/scripts/common/50-install-ollama.sh

      - name: Start Ollama and pull model
        run: bash .github/scripts/common/60-pull-ollama-model.sh

      - name: Configure dockerhost service for Kind
        run: bash .github/scripts/common/70-configure-dockerhost.sh

      - name: Wait for kagenti-operator CRDs to be established
        run: bash .github/scripts/kagenti-operator/41-wait-crds.sh

      # TOOL DEPLOYMENT (FIRST - agent depends on tool being available)
      # Tools are deployed as standard Kubernetes Deployments + Services
      - name: Build weather-tool image
        run: bash .github/scripts/kagenti-operator/71-build-weather-tool.sh

      - name: Deploy weather-tool via Deployment + Service
        run: bash .github/scripts/kagenti-operator/72-deploy-weather-tool.sh

      # AGENT DEPLOYMENT (AFTER tool is ready - agent depends on tool)
      # Uses standard Kubernetes Deployment + Service (no Agent CRD dependency)
      - name: Deploy weather-service Agent
        run: bash .github/scripts/kagenti-operator/74-deploy-weather-agent.sh

      - name: Verify deployment health
        run: |
          chmod +x .github/scripts/verify_deployment.sh
          # Non-blocking: deployments already verified by wait steps
          .github/scripts/verify_deployment.sh || true

      - name: Install test dependencies
        run: bash .github/scripts/common/80-install-test-deps.sh

      - name: Start port-forward for agent service
        run: bash .github/scripts/common/85-start-port-forward.sh

      - name: Pre-flight checks
        if: success()
        run: bash .github/scripts/common/90-preflight-checks.sh

      - name: Run backend E2E tests
        if: success()
        run: bash .github/scripts/kagenti-operator/90-run-e2e-tests.sh

      - name: Run UI E2E tests
        if: success()
        run: bash .github/scripts/common/92-run-ui-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f  # v7.0.0
        with:
          name: e2e-test-results
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: bash .github/scripts/common/99-collect-logs.sh
